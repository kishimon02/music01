# music-create

AI補助型DTMデスクトップアプリのプロトタイプ実装です。  
現在は **ミキシング提案（解析→提案→試聴→適用/巻き戻し）** と **作曲提案（コード/メロディ/ドラム提案→試聴→タイムライン挿入→巻き戻し）** を中心に、実波形入力・C++音声コア再生・タイムライン統合まで実装しています。

## 実装済みフェーズ

1. Phase A: ミキシング基盤（MixerGraph / BuiltinFX / Command / Migration）
2. Phase B: 解析・提案強化（`quick/full`、拡張特徴量、複数候補）
3. Phase C: 提案比較UI（試聴、適用、履歴、巻き戻し）
4. Phase D: DAWタイムライン統合UI（トラックレーン、クリップ、プレイヘッド）
5. Phase E: 実波形入力 + C++音声コア再生
6. Phase F: 音声バックエンド抽象化（`auto` / `winmm` / `juce`差し替え口）
7. Phase G: 実再生プレイヘッド同期 + 波形表示 + 提案エンジン切替（rule/LLM）
8. Phase H: 作曲支援AI基盤 + 量子化グリッド拡張（`1`〜`1/64` + triplet）

## セットアップ

```bash
py -3.12 -m venv .venv
. .venv/Scripts/activate
pip install -e .[dev,ui]
```

## ネイティブ音声コア（C++）ビルド

```bash
music-create-build-native
```

- 出力: `native/build/music_create_audio_core.dll`
- UI起動時も自動ビルドを試みます（初回のみ数秒かかる場合があります）
- バックエンド選択は環境変数 `MUSIC_CREATE_AUDIO_BACKEND`（`auto` / `winmm` / `juce`）で指定可能です

## 実行

### APIサーバー

```bash
uvicorn music_create.api.server:app --reload
```

- `http://127.0.0.1:8000/`（ステータス）
- `http://127.0.0.1:8000/docs`（Swagger UI）

### 統合デスクトップUI

```bash
music-create-ui
```

- 画面構成は「操作タブ（DAW / ミキシング）」です。
- 作曲支援パネルはDAWタブ内に統合されています。
- ウィンドウ全体は縦スクロール対応で、表示が見切れる場合はスクロールして操作できます。

## UI操作ドキュメント（詳細）

### 1. 基本フロー（ミキシング）

1. `DAW` タブでタイムライン行をクリックして対象トラックを選択
3. `WAV読込` でWAVファイルを割り当て
4. `再生` / `停止` で音を確認
5. `解析` で特徴量抽出
6. `ミキシング` タブで `提案` を実行して候補生成
7. 候補を選択して `試聴` / `試聴取消` / `適用` / `選択を巻き戻し`

### 1.1 基本フロー（作曲）

1. `DAW` タブ内の `作曲支援` パネルで `挿入トラックID` / `パート` / `キー` / `スケール` / `スタイル` / `グリッド` / `小節数` / `楽器` を設定
3. `作曲提案` で候補を生成
4. 候補を選択して `作曲試聴` で確認
5. `タイムライン挿入` でMIDIクリップとして反映
6. 必要に応じて `挿入を巻き戻し`

### 2. コントロール詳細

#### トラック・解析設定

- `トラックID`
  - 現在操作対象のトラックIDです。
  - タイムライン行クリックで自動同期されます。

- `プロファイル`
  - `クリーン` / `パンチ` / `ウォーム` の3種類。
  - 提案生成時の音作り方向に反映されます。

- `提案エンジン`
  - `ルールベース` / `LLMベース` を切替。
  - `LLMベース` 失敗時は自動で `ルールベース` にフォールバックします。

- `解析モード`
  - `高速（quick）`: 低遅延重視
  - `詳細（full）`: より多い解析指標

- `作曲グリッド`
  - 作曲提案の量子化グリッドです（既定 `1/16`）。
  - `1`, `1/2`, `1/2T`, `1/4`, `1/4T`, `1/8`, `1/8T`, `1/16`, `1/16T`, `1/32`, `1/32T`, `1/64` を選択できます。

#### WAV/再生

- `WAV読込`
  - 選択トラックにWAVを紐付けます。
  - 読込後、波形表示とWAV情報が更新されます。

- `再生`
  - C++音声コアで再生します。
  - 試聴中または適用済みFXがある場合、提案反映音で再生されます。

- `停止`
  - 再生停止し、再生同期タイマーを解除します。

#### ミキシング提案

- `解析`
  - 対象トラック波形から特徴量を抽出。
  - 解析結果（LUFS、Peak、RMS、スペクトル重心など）を表示。

- `提案`
  - 解析結果 + プロファイル + エンジン設定を使って候補を生成。
  - 候補一覧はスコア順で表示されます。

- `Dry/Wet`
  - `試聴` 時の反映量（0%〜100%）です。

### 3. ボタン動作（`試聴` / `試聴取消` / `適用` / `選択を巻き戻し`）

#### `試聴`

- 選択候補を Dry/Wet 量で一時反映します。
- 一時反映のため、履歴（コマンド履歴）は増えません。
- `再生` すると、試聴中の状態で音が鳴ります。

#### `試聴取消`

- `試聴` 前の状態に戻します。
- 履歴は増えません。
- 取消後の `再生` は、試聴前（または直近適用済み）状態の音になります。

#### `適用`

- 選択候補を 100% で確定適用します。
- `SuggestionCommand` が1件作成され、履歴一覧に追加されます。
- 適用後の `再生` は、適用済み状態の音になります。

#### `選択を巻き戻し`

- 履歴で選択したコマンドの `before` 状態へ戻します。
- 巻き戻したコマンドは未適用状態になります。
- ほかの履歴エントリは削除しません。

### 4. タイムライン操作

- `トラック追加`: トラックを追加
- `MIDIクリップ追加`: 選択トラックへMIDIクリップ追加
- `オーディオクリップ追加`: 選択トラックへAudioクリップ追加
- `音階表示`: 選択したMIDIクリップに含まれるノート名（例: `C4`, `E4`, `G4`）を表示
- `簡易ピアノロール`: 選択したMIDIクリップのノート配置（時間×音高）を表示
- `音階/楽器を反映`: 選択MIDIの半音シフトと楽器Program変更を手動反映
- `選択MIDI試聴`: 編集後のMIDIをその場で試聴
- 再生中はプレイヘッドと波形カーソルが同期して進行

### 5. 作曲支援パネル操作（`作曲提案` / `作曲試聴` / `タイムライン挿入` / `挿入を巻き戻し`）

#### `作曲提案`

- 設定したパラメータで作曲候補を最大3件生成します。
- `LLMベース` 選択時に失敗すると `ルールベース` に自動フォールバックします。
- 候補一覧にはソース、スコア、ノート数が表示されます。

#### `作曲試聴`

- 選択候補から試聴用WAVを生成し、C++音声コアで再生します。
- タイムラインへはまだ挿入しません（プレビューのみ）。
- 楽器Programに応じて音色が変わります。

#### `タイムライン挿入`

- 選択候補をMIDIクリップとして挿入します。
- 挿入位置は対象トラック末尾の次小節です。
- 末尾に入らない場合は、収まる範囲に調整して挿入します。

#### `挿入を巻き戻し`

- 作曲挿入履歴から選択したコマンドの作成クリップを削除します。
- 巻き戻したコマンドは未適用状態になります。

## 作曲支援AI（現状）

### 実装済み（UI/バックエンド/API）

- パート: `chord` / `melody` / `drum`
- エンジン: `rule-based`（既定）/ `llm-based`（失敗時フォールバック）
- UI: DAW統合作曲支援パネル（提案、試聴、タイムライン挿入、巻き戻し）
- UI: DAW内の簡易ピアノロール + 音階/楽器の手動編集
- 量子化グリッド:
  - `1`, `1/2`, `1/2T`, `1/4`, `1/4T`, `1/8`, `1/8T`, `1/16`, `1/16T`, `1/32`, `1/32T`, `1/64`
- 内部tick:
  - `ticks_per_beat = 960`
- API:
  - `POST /v1/compose/suggest`

### API使用例（作曲提案）

```bash
curl -X POST http://127.0.0.1:8000/v1/compose/suggest \
  -H "Content-Type: application/json" \
  -d '{
    "track_id":"track-1",
    "part":"melody",
    "key":"C",
    "scale":"major",
    "bars":4,
    "style":"pop",
    "grid":"1/8T",
    "program":0,
    "engine_mode":"rule-based"
  }'
```

## 環境変数

- 音声バックエンド
  - `MUSIC_CREATE_AUDIO_BACKEND=auto|winmm|juce`

- ミキシング提案エンジン
  - `MUSIC_CREATE_SUGGESTION_ENGINE=rule-based|llm-based`

- LLM（ミキシング/作曲共通）
  - `MUSIC_CREATE_LLM_ENDPOINT`
  - `MUSIC_CREATE_LLM_API_KEY`（任意）
  - `MUSIC_CREATE_LLM_MODEL`（任意）
  - `MUSIC_CREATE_LLM_TIMEOUT_SEC`（任意）

## テスト

```bash
pytest -q
```

主な追加テスト:

- 量子化テーブル12値 + triplet丸め
- 作曲APIのグリッド許可/拒否
- LLM不正グリッド時のrule-basedフォールバック
- `default_grid` 不正値読込時の `1/16` 補正 + 警告履歴

## ドキュメント

1. 全体アーキテクチャ: `docs/architecture.md`
2. 詳細設計書: `docs/design.md`

## 補足

1. 既定のネイティブ再生バックエンドは `auto`（Windowsでは `cpp-winmm`）です。
2. `juce` は差し替え口（プレースホルダー）で、C API互換を維持したまま本実装へ置換可能です。
3. UI表示文言と本リポジトリのドキュメントは日本語で管理します。
